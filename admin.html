!DOCTYPE html
html lang=pl
head
  meta charset=UTF-8 
  titlePanel administratoratitle
  meta name=viewport content=width=device-width, initial-scale=1.0 
  style
    body { font-family Arial; background #f8f6ec; padding 20px; margin 0; }
    header {
      background #1e3615; color white; padding 15px; display flex; justify-content space-between;
    }
    nav button {
      margin-right 10px; padding 10px; border none; background #336633; color white;
      border-radius 5px; cursor pointer;
    }
    .section { display none; margin-top 20px; }
    table { width 100%; border-collapse collapse; }
    th, td { border 1px solid #ccc; padding 8px; text-align left; }
    th { background #eee; }
    button.delete { background red; color white; padding 5px; border none; border-radius 4px; cursor pointer; }
  style
  script src=httpswww.gstatic.comfirebasejs9.22.2firebase-app-compat.jsscript
  script src=httpswww.gstatic.comfirebasejs9.22.2firebase-firestore-compat.jsscript
  script src=httpscdnjs.cloudflare.comajaxlibsPapaParse5.4.1papaparse.min.jsscript
head
body
  header
    divstrongPanel administratorastrongdiv
    divbutton onclick=logOut()Wylogujbuttondiv
  header

  nav
    button onclick=showSection('zgloszenia')Zgłoszeniabutton
    button onclick=showSection('uzytkownicy')Użytkownicybutton
    button onclick=showSection('statystyki')Statystykibutton
    button onclick=exportCSV()Eksport CSVbutton
  nav

  div id=zgloszenia class=section
    h2Zgłoszeniah2
    table id=taskTable
      theadtrthAdresththKlientththStatusththAgentththAkcjethtrthead
      tbodytbody
    table
  div

  div id=uzytkownicy class=section
    h2Użytkownicyh2
    form onsubmit=addUser(event)
      input type=text id=userId placeholder=ID użytkownika required 
      input type=text id=userHaslo placeholder=Hasło required 
      select id=userRola
        option value=agentAgentoption
        option value=callcenterCall Centeroption
        option value=adminAdministratoroption
      select
      button type=submitDodajbutton
    form
    ul id=userListul
  div

  div id=statystyki class=section
    h2Statystykih2
    div id=statsdiv
  div

  script
    const firebaseConfig = {
      apiKey AIzaSyBIwz2juFmcNOVorEywVj8U040GgT3euVQ,
      authDomain mesi-a81c4.firebaseapp.com,
      projectId mesi-a81c4
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const user = localStorage.getItem(user);
    const rola = localStorage.getItem(rola);
    if (rola !== admin) location.href = index.html;

    function showSection(id) {
      document.querySelectorAll('.section').forEach(s = s.style.display = 'none');
      document.getElementById(id).style.display = 'block';
      if (id === 'zgloszenia') loadTasks();
      if (id === 'uzytkownicy') loadUsers();
      if (id === 'statystyki') loadStats();
    }

    function logOut() {
      localStorage.clear();
      location.href = index.html;
    }

    async function loadTasks() {
      const tbody = document.querySelector(#taskTable tbody);
      tbody.innerHTML = ;
      const snap = await db.collection(tasks).get();
      snap.forEach(doc = {
        const t = doc.data();
        const tr = document.createElement(tr);
        tr.innerHTML = `td${t.ulica  }, ${t.kod  } ${t.miasto  }td
                       td${t.name  } (${t.phone  })td
                       td${t.status  }td
                       td${t.agent  -}td
                       tdbutton class='delete' onclick='deleteTask(${doc.id})'Usuńbuttontd`;
        tbody.appendChild(tr);
      });
    }

    async function deleteTask(id) {
      if (confirm(Na pewno usunąć)) {
        await db.collection(tasks).doc(id).delete();
        loadTasks();
      }
    }

    async function loadUsers() {
      const ul = document.getElementById(userList);
      ul.innerHTML = ;
      const snap = await db.collection(users).get();
      snap.forEach(doc = {
        const d = doc.data();
        const li = document.createElement(li);
        li.textContent = `${doc.id} (${d.rola})`;
        ul.appendChild(li);
      });
    }

    async function addUser(e) {
      e.preventDefault();
      const id = document.getElementById(userId).value;
      const haslo = document.getElementById(userHaslo).value;
      const rola = document.getElementById(userRola).value;
      await db.collection(users).doc(id).set({ kod haslo, rola });
      loadUsers();
    }

    async function loadStats() {
      const snap = await db.collection(tasks).get();
      const stats = { lacznie 0, zrealizowane 0, dostepne 0, wtrakcie 0 };
      snap.forEach(doc = {
        stats.lacznie++;
        const s = doc.data().status;
        if (s === Zrealizowane) stats.zrealizowane++;
        else if (s === Dostępne) stats.dostepne++;
        else if (s === W trakcie) stats.wtrakcie++;
      });
      document.getElementById(stats).innerHTML =
        `Lącznie zgłoszeń ${stats.lacznie}br ` +
        `Zrealizowane ${stats.zrealizowane}br ` +
        `W trakcie ${stats.wtrakcie}br ` +
        `Dostępne ${stats.dostepne}`;
    }

    async function exportCSV() {
      const snap = await db.collection(tasks).get();
      const rows = [];
      snap.forEach(doc = {
        const d = doc.data();
        rows.push({
          Adres `${d.ulica  }, ${d.kod  } ${d.miasto  }`,
          Klient d.name,
          Telefon d.phone,
          Status d.status,
          Agent d.agent  -,
          Umowa d.umowa  ,
          Komentarz d.komentarz  
        });
      });
      const csv = Papa.unparse(rows);
      const blob = new Blob([csv], { type textcsv;charset=utf-8; });
      const link = document.createElement(a);
      link.href = URL.createObjectURL(blob);
      link.download = zgloszenia.csv;
      link.click();
    }

    showSection('zgloszenia');
  script
body
html
